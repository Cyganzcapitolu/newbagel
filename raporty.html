<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Raporty Miesięczne</title>
</head>
<body>
  <h1>Raporty Miesięczne</h1>
  <label for="month">Wybierz miesiąc:</label>
  <input type="month" id="month">
  <button onclick="generujRaport()">Generuj</button>

  <h2>Raport Finansowy</h2>
  <p>Suma zamówień: <span id="sumaZamowien">-</span> zł</p>
  <p>Suma po rabacie: <span id="sumaPoRabacie">-</span> zł</p>

  <h2>Raport Towarowy</h2>
  <ul id="towary"></ul>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = 'https://bmeyrkcwhkatdsdrouvh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Wklej pełny
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function generujRaport() {
      const miesiac = document.getElementById('month').value;
      if (!miesiac) return alert("Wybierz miesiąc!");

      const start = new Date(miesiac + "-01T00:00:00");
      const end = new Date(start);
      end.setMonth(end.getMonth() + 1);

      const { data, error } = await supabase
        .from("orders")
        .select("*")
        .gte("date", start.toISOString())
        .lt("date", end.toISOString());

      if (error) {
        alert("Błąd przy pobieraniu danych: " + error.message);
        return;
      }

      let suma = 0;
      let sumaPoRabacie = 0;
      const towar = {};

      data.forEach(z => {
        suma += z.total;
        sumaPoRabacie += z.discounted;

        const produkty = z.items.split(', ');
        produkty.forEach(p => {
          const [qty, ...nameParts] = p.split('x ');
          const name = nameParts.join('x ').trim();
          const ilość = parseInt(qty) || 1;
          if (!towar[name]) towar[name] = 0;
          towar[name] += ilość;
        });
      });

      document.getElementById('sumaZamowien').textContent = suma.toFixed(2);
      document.getElementById('sumaPoRabacie').textContent = sumaPoRabacie.toFixed(2);

      const ul = document.getElementById('towary');
      ul.innerHTML = '';
      for (const [produkt, ilosc] of Object.entries(towar)) {
        const li = document.createElement('li');
        li.textContent = `${produkt}: ${ilosc} szt.`;
        ul.appendChild(li);
      }
    }
  </script>
</body>
</html>
